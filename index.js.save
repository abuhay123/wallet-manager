const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const fs = require('fs');
const web3 = require('@solana/web3.js');

const app = express();
app.use(cors());
app.use(bodyParser.json());
app.use(express.static('public'));

const PORT const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const fs = require('fs');
const web3 = require('@solana/web3.js');

const app = express();
app.use(cors());
app.use(bodyParser.json());
app.use(express.static('public'));

const PORT = 3000;

// ×™×¦×™×¨×ª 100 ××¨× ×§×™×
app.post('/create-wallets', async (req, res) => {
  const wallets = [];
  for (let i = 0; i < 100; i++) {
    const keypair = web3.Keypair.generate();
    wallets.push({
      publicKey: keypair.publicKey.toBase58(),
      secretKey: Buffer.from(keypair.secretKey).toString('base64'),
    });
  }
  fs.writeFileSync('wallets.json', JSON.stringify(wallets, null, 2));
  res.send({ message: 'âœ… × ×•×¦×¨×• 100 ××¨× ×§×™×' });
});

// ×©×œ×™×¤×ª ××¨× ×§×™×
app.get('/wallets.json', (req, res) => {
  const data = fs.readFileSync('wallets.json');
  res.send(JSON.parse(data));
});

// ×‘×“×™×§×ª ×™×ª×¨×”
app.get('/balance', async (req, res) => {
  const pubKey = new web3.PublicKey(req.query.pubKey);
  const connection = new web3.Connection(web3.clusterApiUrl('mainnet-beta'));
  const balance = await connection.getBalance(pubKey);
  res.send({ balance: balance / web3.LAMPORTS_PER_SOL });
});

// ×©×œ×™×—×” ××›×œ ×”××¨× ×§×™×
app.post('/send-all', async (req, res) => {
  const { to, amount } = req.body;
  if (!to || !amount) return res.status(400).send({ message: "× ×ª×•× ×™× ×—×¡×¨×™×" });

  const connection = new web3.Connection(web3.clusterApiUrl('mainnet-beta'));
  const wallets = JSON.parse(fs.readFileSync('wallets.json'));
  const destination = new web3.PublicKey(to);
  const lamports = amount * web3.LAMPORTS_PER_SOL;
  let successCount = 0;

  for (let i = 0; i < wallets.length; i++) {
    try {
      const secretKey = Uint8Array.from(Buffer.from(wallets[i].secretKey, 'base64'));
      const keypair = web3.Keypair.fromSecretKey(secretKey);
      const tx = new web3.Transaction().add(
        web3.SystemProgram.transfer({
          fromPubkey: keypair.publicKey,
          toPubkey: destination,
          lamports: lamports,
        })
      );
      await web3.sendAndConfirmTransaction(connection, tx, [keypair]);
      successCount++;
    } catch (err) {
      console.log(`âŒ ××¨× ×§ ${i + 1} × ×›×©×œ: ${err.message}`);
    }
  }

  res.send({ message: `ğŸ“¤ ×©×œ×™×—×” ×”×¦×œ×™×—×” ×Ö¾${successCount} ××¨× ×§×™×.` });
});

// ×§× ×™×™×” (×§×‘×œ×ª SOL ××›×œ ×”××¨× ×§×™× ××›×ª×•×‘×ª)
app.post('/buy-all', async (req, res) => {
  const { from, amount } = req.body;
  if (!from || !amount) return res.status(400).send({ message: "× ×ª×•× ×™× ×—×¡×¨×™×" });

  const connection = new web3.Connection(web3.clusterApiUrl('mainnet-beta'));
  const sender = new web3.PublicKey(from);
  const lamports = amount * web3.LAMPORTS_PER_SOL;
  const wallets = JSON.parse(fs.readFileSync('wallets.json'));
  let successCount = 0;

  for (let i = 0; i < wallets.length; i++) {
    try {
      const secretKey = Uint8Array.from(Buffer.from(wallets[i].secretKey, 'base64'));
      const keypair = web3.Keypair.fromSecretKey(secretKey);

      const tx = new web3.Transaction().add(
        web3.SystemProgram.transfer({
          fromPubkey: sender,
          toPubkey: keypair.publicKey,
          lamports: lamports,
        })
      );

      // ×©×™× ×œ×‘: ×–×” ×œ× ×™×¢×‘×•×“ ×‘×œ×™ ×’×™×©×” ×œ××¤×ª×— ×”×¤×¨×˜×™ ×©×œ "from"
      // ×›××Ÿ ×œ×¦×•×¨×š ×¡×™××•×œ×¦×™×” ×‘×œ×‘×“
      successCount++;
    } catch (err) {
      console.log(`âŒ ×§× ×™×™×” ×œ××¨× ×§ ${i + 1} × ×›×©×œ×”: ${err.message}`);
    }
  }

  res.send({ message: `ğŸ’° ×”×•×¢×‘×¨×• ${amount} SOL ×œ-${successCount} ××¨× ×§×™× (×¡×™××•×œ×¦×™×” ×‘×œ×‘×“)` });
});

// ××›×™×¨×” - ×©×œ×™×—×” ××›×œ ×”××¨× ×§×™× ×œ×›×ª×•×‘×ª ××—×ª
app.post('/sell-all', async (req, res) => {
  const { to, amount } = req.body;
  if (!to || !amount) return res.status(400).send({ message: "× ×ª×•× ×™× ×—×¡×¨×™×" });

  const connection = new web3.Connection(web3.clusterApiUrl('mainnet-beta'));
  const destination = new web3.PublicKey(to);
  const lamports = amount * web3.LAMPORTS_PER_SOL;
  const wallets = JSON.parse(fs.readFileSync('wallets.json'));
  let successCount = 0;

  for (let i = 0; i < wallets.length; i++) {
    try {
      const secretKey = Uint8Array.from(Buffer.from(wallets[i].secretKey, 'base64'));
      const keypair = web3.Keypair.fromSecretKey(secretKey);

      const tx = new web3.Transaction().add(
        web3.SystemProgram.transfer({
          fromPubkey: keypair.publicKey,
          toPubkey: destination,
          lamports: lamports,
        })
      );

      await web3.sendAndConfirmTransaction(connection, tx, [keypair]);
      successCount++;
    } catch (err) {
      console.log(`âŒ ××›×™×¨×” ×××¨× ×§ ${i + 1} × ×›×©×œ×”: ${err.message}`);
    }
  }

  res.send({ message: `ğŸ’µ × ××›×¨×• SOL ×Ö¾${successCount} ××¨× ×§×™×.` });
});
app.post('/send-one', async (req, res) => {
  const { secretKey, to, amount } = req.body;
  if (!secretKey || !to || !amount) return res.status(400).send({ message: "× ×ª×•× ×™× ×—×¡×¨×™×" });

  const connection = new web3.Connection(web3.clusterApiUrl('mainnet-beta'));
  const keypair = web3.Keypair.fromSecretKey(Uint8Array.from(Buffer.from(secretKey, 'base64')));
  const destination = new web3.PublicKey(to);
  const lamports = amount * web3.LAMPORTS_PER_SOL;

  try {
    const tx = new web3.Transaction().add(
      web3.SystemProgram.transfer({
        fromPubkey: keypair.publicKey,
        toPubkey: destination,
        lamports,
      })
    );

    const sig = await web3.sendAndConfirmTransaction(connection, tx, [keypair]);
    res.send({ message: `âœ… × ×©×œ×— ${amount} SOL. ×—×ª×™××”: ${sig}` });
  } catch (err) {
    res.status(500).send({ message: `âŒ ×©×’×™××”: ${err.message}` });
  }
});


app.listen(PORT, () => {
  console.log(`ğŸš€ ×©×¨×ª ×¨×¥ ×¢×œ http://localhost:${PORT}`);
});
